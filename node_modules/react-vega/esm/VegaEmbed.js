import "core-js/modules/es.array.concat";
import "core-js/modules/es.array.from";
import "core-js/modules/es.array.index-of";
import "core-js/modules/es.array.some";
import "core-js/modules/es.object.keys";
import "core-js/modules/es.string.iterator";
import _pt from "prop-types";

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

import React from 'react';
import vegaEmbed from 'vega-embed';
import shallowEqual from './utils/shallowEqual';
import getUniqueFieldNames from './utils/getUniqueFieldNames';
import { NOOP } from './constants';
import addSignalListenersToView from './utils/addSignalListenersToView';
import computeSpecChanges from './utils/computeSpecChanges';
import removeSignalListenersFromView from './utils/removeSignalListenersFromView';

var VegaEmbed =
/*#__PURE__*/
function (_React$PureComponent) {
  _inheritsLoose(VegaEmbed, _React$PureComponent);

  function VegaEmbed() {
    var _this;

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _React$PureComponent.call.apply(_React$PureComponent, [this].concat(args)) || this;

    _defineProperty(_assertThisInitialized(_this), "containerRef", React.createRef());

    _defineProperty(_assertThisInitialized(_this), "viewPromise", void 0);

    _defineProperty(_assertThisInitialized(_this), "handleError", function (error) {
      var _this$props$onError = _this.props.onError,
          onError = _this$props$onError === void 0 ? NOOP : _this$props$onError;
      onError(error); // eslint-disable-next-line no-console

      console.warn(error);
      return undefined;
    });

    _defineProperty(_assertThisInitialized(_this), "modifyView", function (action) {
      if (_this.viewPromise) {
        _this.viewPromise.then(function (view) {
          if (view) {
            action(view);
          }

          return true;
        }).catch(_this.handleError);
      }
    });

    return _this;
  }

  var _proto = VegaEmbed.prototype;

  _proto.componentDidMount = function componentDidMount() {
    this.createView();
  };

  _proto.componentDidUpdate = function componentDidUpdate(prevProps) {
    var _this2 = this;

    var fieldSet = getUniqueFieldNames([this.props, prevProps]);
    fieldSet.delete('className');
    fieldSet.delete('signalListeners');
    fieldSet.delete('spec');
    fieldSet.delete('style'); // Only create a new view if necessary

    if (Array.from(fieldSet).some(function (f) {
      return _this2.props[f] !== prevProps[f];
    })) {
      this.clearView();
      this.createView();
    } else {
      var specChanges = computeSpecChanges(this.props.spec, prevProps.spec);
      var newSignalListeners = this.props.signalListeners;
      var oldSignalListeners = prevProps.signalListeners;

      if (specChanges) {
        if (specChanges.isExpensive) {
          this.clearView();
          this.createView();
        } else {
          var areSignalListenersChanged = !shallowEqual(newSignalListeners, oldSignalListeners);
          this.modifyView(function (view) {
            if (specChanges.width !== false) {
              view.width(specChanges.width);
            }

            if (specChanges.height !== false) {
              view.height(specChanges.height);
            }

            if (areSignalListenersChanged) {
              if (oldSignalListeners) {
                removeSignalListenersFromView(view, oldSignalListeners);
              }

              if (newSignalListeners) {
                addSignalListenersToView(view, newSignalListeners);
              }
            }

            view.run();
          });
        }
      } else {
        var _areSignalListenersChanged = !shallowEqual(newSignalListeners, oldSignalListeners);

        this.modifyView(function (view) {
          if (_areSignalListenersChanged) {
            if (oldSignalListeners) {
              removeSignalListenersFromView(view, oldSignalListeners);
            }

            if (newSignalListeners) {
              addSignalListenersToView(view, newSignalListeners);
            }
          }

          view.run();
        });
      }
    }
  };

  _proto.componentWillUnmount = function componentWillUnmount() {
    this.clearView();
  };

  _proto.createView = function createView() {
    var _this$props = this.props,
        spec = _this$props.spec,
        onNewView = _this$props.onNewView,
        _this$props$signalLis = _this$props.signalListeners,
        signalListeners = _this$props$signalLis === void 0 ? {} : _this$props$signalLis,
        options = _objectWithoutPropertiesLoose(_this$props, ["spec", "onNewView", "signalListeners"]);

    if (this.containerRef.current) {
      this.viewPromise = vegaEmbed(this.containerRef.current, spec, options).then(function (_ref) {
        var view = _ref.view;

        if (addSignalListenersToView(view, signalListeners)) {
          view.run();
        }

        return view;
      }).catch(this.handleError);

      if (onNewView) {
        this.modifyView(onNewView);
      }
    }
  };

  _proto.clearView = function clearView() {
    this.modifyView(function (view) {
      view.finalize();
    });
    this.viewPromise = undefined;
    return this;
  };

  _proto.render = function render() {
    var _this$props2 = this.props,
        className = _this$props2.className,
        style = _this$props2.style;
    return (// Create the container Vega draws inside
      React.createElement("div", {
        ref: this.containerRef,
        className: className,
        style: style
      })
    );
  };

  return VegaEmbed;
}(React.PureComponent);

_defineProperty(VegaEmbed, "propTypes", {
  className: _pt.string,
  onError: _pt.func
});

export { VegaEmbed as default };